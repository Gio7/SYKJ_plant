name: iOS_Build and Distribute

on:
  workflow_dispatch:
  # push:
  #   branches:
  #     - main

jobs:
  build:
    if: github.repository == 'SuperInteractica/PlantIdentification'
    name: build
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v2

      - uses: subosito/flutter-action@v1
        with:
          flutter-version: '3.22.3' 

      - uses: cedvdb/action-flutter-build-ios@v1
        with:
          build-cmd: flutter build ipa --release --export-options-plist=ios/ExportOptions_pro.plist
          certificate-base64: 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
          certificate-password: 123
          provisioning-profile-base64: ${{ secrets.BUILD_PROVISION_PROFILE_BASE64 }}
          keychain-password: ${{ secrets.KEYCHAIN_PASSWORD }}
      - name: Archive IPA
        uses: actions/upload-artifact@v4
        with:
          name: release-ipa
          path: build/ios/ipa
      
      - name: Upload using iTMSTransporter
        env:
          WORKING_DIRECTORY: build/ios/ipa
          IPA_FILE_NAME: Plant Identifier.ipa
          APPLE_USERNAME: ${{ secrets.APPLE_USERNAME }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_ASC_PROVIDER: ADKZT87JCB
        run: |
          cd $WORKING_DIRECTORY
          git clone https://github.com/ZhangLi1984/itsm.git
          ./itsm/bin/iTMSTransporter -assetFile $IPA_FILE_NAME -u $APPLE_USERNAME -p $APPLE_PASSWORD -m upload -asc_provider $APPLE_ASC_PROVIDER